---
tags: 
type: page
---

## Введение: модульный и сквозной подходы
### Модульный и сквозной (End To End) подход
- Два подхода: модульный и сквозной
- Сквозной подход объединяет несколько модулей в модель глубокого обучения

### Преимущества сквозного подхода
#### Простота архитектуры системы
Отсутствие большого числа модулей упрощает общую систему. Не нужно разрабатывать и отлаживать отдельно детектор объектов, модуль предсказания, планирования – вместо этого единая обученная модель решает задачу целиком. 
- Это устраняет проблему интеграции компонентов и их несовместимости (например, зависимость от формата сообщений ROS).
- Система становится легче переносима между платформами (не зависит от множества внешних библиотек). 
- Проще масштабировать код (на новые локации или типы беспилотников). По сути, основной код это запуск нейросети да обработка данных.

#### Отсутствие ручного проектирования признаков
Классические системы требуют вручную задать, что именно машина должна видеть (линии, светофоры, знаки, определенные объекты) и как на основе этого принимать решения. Сквозной подход избавляет от этой ручной работы – модель сама извлекает нужные признаки из сырых пикселей и сама определяет, как их использовать для оптимального управления. Нейросеть может научиться тонким вещам, которые человек-инженер мог упустить.
- Распознавание: например, приходится вручную выделять классы велосипедиста, мотоциклиста, пешехода и других чтобы по-разному их описать и реагировать на их поведение. 
- Планирование: ручная настройка проезда нерегулируемого перекрестка. В общественном беспилотном транспорте задача ручной настройки правильного взаимодействия с пассажирами на остановках (нужно дождаться всех желающих зайти в вагон, и успеть следовать по расписанию).

#### Совместная оптимизация и глобальный критерий
End-to-end модель оптимизирует единый целевой критерий – безопасное и комфортное движение. 
- В модульном подходе разные части оптимизируются по своим локальным метрикам (детектор объектов – по точности распознавания, модуль предсказания - по точности предсказанной траектории, планировщик – например, по длине пути с учетом ограничений безопасности и комфорта и т.п.), что не гарантирует оптимального всего вождения. 
- В совместно обученной модели все слои настраиваются так, чтобы минимизировать конечную ошибку управления или максимизировать награду движения. Это теоретически позволяет достичь более скоординированного и слаженного поведения, избегая конфликтов между модулями. 
- **Различная важность объектов для планирования пути**. Например, детектор объектов оптимизируется на всех объектах сцены, минимизируя среднюю ошибку по ним. Однако, очевидно, что для планировщика не все объекты одинаково важны и может быть ситуация в которой средняя метрика детекции выросла за счет большого числа объектов на парковке в стороне, при этом был пропущен объект впереди трамвая. Такое поведение будет закрепляться в процессе обучения. Это пример, когда повышение локальной метрики может даже уменьшить глобальную. Выхода два: привести локальную метрику в соответствие с глобальной например, повысив вклад объектов впереди по сравнению с объектами, еще находящимися в поле видимости, но которых беспилотник уже проехал или обучать модель сразу на глобальной метрике сквозным подходом.
- **Баланс между точностью и полнотой распознавания**. Часто в качестве критерия для выбора порога отсечения детекций по уверенности используется мера F1, т.е. равный вес ошибок первого и второго рода. Однако это смещение в сторону полноты ради не допущения пропуска объекта может вылиться в чрезмерно аккуратное и дерганое поведение из-за большого числа ложно положительных ошибок.
- **Максимально точные предсказания движения других участников**. Улучшение локальной метрики предсказания траекторий объектов (RMSE) тоже может не согласовываться с улучшением глобального качества вождения. Если модуль предсказания **слишком сфокусирован на минимизации средней ошибки**, он может «пренебрегать» маловероятными сценариями. Формально, когда мы вычисляем MSE, редкое отклонение в паре кадров даёт маленький вклад в усреднённую ошибку (особенно если остальные 90–95% данных – «нормальные» траектории). Система «учится» делать максимально хорошие предсказания для **большинства** случаев, а редкие сценарии с «всплесками» (например, пешеход резко побежал) могут давать мизерный вклад в общую ошибку, и их прогностическая точность при этом может сильно страдать.
- **Планировщик «короткого и быстрого пути»**. Планировщик, руководствуясь, например, критерием «максимально короткое время в пути», старается прокладывать оптимальную с этой точки зрения траекторию. Такая траектория может в реальности может создавать опасные дорожные ситуации.
- **Отдельная оптимизация трекинга объектов**. Модуль трекинга (отслеживания) объектов пытается сгладить траектории, убирая шум в детекциях. Он сводит к минимуму ошибку «дёргания» треков (например, используя фильтра Калмана). При этом треки, начинающиеся с неуверенных детекций будут создаваться с задержкой, так же как начало действительных резких маневров объектов будет чрезмерно фильтроваться.
- **Противоречивые сигналы “уверенности” между модулями**. Каждый модуль (детекция, предсказание, принятие решения) пытается формировать «уверенность» в своих результатах, чтобы по возможности фильтровать шум. Это может приводить к накоплению ошибки, где важный объект в глобальном контексте был пропущен как ненадежный локальным модулем.

#### Избежание накопления ошибок (error propagation)
В классической архитектуре ошибка на раннем этапе (знак не был замечен или неправильно распознана дистанция) передается дальше и может привести к неверному плану. Сквозной подход снижает эту проблему, так как нет узких мест интерфейсов – решение принимается на основе сырой сцены напрямую. Если где-то чуть ошиблись во внутренней оценке, сеть теоретически может компенсировать это в следующем слое, если финальная ошибка управления слишком растет. Практически это проявляется, например, устойчивостью к частичным потерям разметки – сеть может ориентироваться по обочине или соседним машинам, даже если дорожная линия не видна, вместо того 
чтобы потеряться из-за отсутствия входа от детектора разметки.

#### Избежание потери информации
Если устойчивость к ошибкам каждого модуля можно в какой-то степени повысить, то остается проблема потери информации между ними. Каждый модуль работает со своим набором абстракций: мир делится на объекты и среду, объекты на конечный набор классов, объекты движутся по заданному набору возможных траекторий, представленных определенным образом, планирование строится по заданному набору правил и ограничений. Сквозной подход нивелирует такие потери, выстраивая маршрут на основе сырых данных как источнике информации об окружающей действительности, не ограничивая это представление заданными человеком абстракциями.

#### Потенциальная способность к обобщению
При наличии очень большого и разнообразного обучающего набора end-to-end модель может впитать в себя богатый опыт, охватывающий множество ситуаций (различные города, погода, стили вождения). Такая модель может быть способна адаптироваться к новым ситуациям лучше, чем набор жестких правил. Есть предположение, что крайне масштабные модели (сотни миллионов параметров), обученные на миллионах километров, смогут достичь человеческого уровня гибкости, тогда как модульный подход все равно будет ограничен заранее заданными правилами и объектами. 
Обучаясь на сырых данных и имея достаточное число параметров, можно выучить более общие признаки объектов и окружения

#### Способность работы в неоднозначных ситуациях
За счет сквозного обучения сеть может научиться тонким корреляциям. Например, по едва заметному изменению общего вида городской застройки вдали, сеть может распознать приближение перекрестка даже без четких линий на дороге или снизить скорость в сильный снегопад, остановиться перед пешеходом, готовым сделать шаг на пешеходном переходе. Все это сложно прописать в явных правилах. Сквозной системе иногда проще принять семантически неоднозначное решение, потому что она не привязана к строго дискретным сигналам (типа «видит знак или нет»). Система работает в нечеткой логике, оперируя вероятностями на всем пути обработки данных от сенсоров до выдачи управляющих сигналов. Даже при наличии только части информации сеть может выдать «интуитивно правильное» действие, как сделал бы человек, опираясь на совокупность слабых признаков. 

### Участники гонки
[Waymo](https://waymo.com/blog/2024/10/introducing-emma)
[Tesla](https://www.youtube.com/watch?v=Voe8l7YeXdc)
[Wayve](https://wayve.ai/technology/#AV2.0)
Яндекс - [[Нейронные сети для планирования движения беспилотных автомобилей]]
Xpeng - [[CVPR23 E2EAD. XPeng E2E Perception. Patrick Langechuan Liu, Invited Talk]]
### Введение
Может показаться, что задача построения такой сквозной системы автопилота это сильно далекая перспектива. Одно далее мы увидим, что подобный подход уже применяется на мировой практике и даже более того, мы сами уже встали на этот тернистый путь!
С целью сделать погружение в детали сквозной архитектуры более плавным, далее будем постепенно строить систему автопилота постепенно уменьшая ее модульность.

## Сквозное распознавание
### Модульная архитектура
Лидар -> Детекция -> 
Камера -> Детекция -> Фьюзинг -> Трекинг
Радар -> Детекция -> 
### Сквозная архитектура
## Восприятие + предсказание

### Данные

Последовательности кадров (сцены)

### Архитектура

Доп. голова для регрессии траекторий

### Функция потерь

Для детекции и предсказания

### Что дает подход

### Опыт Xpeng
### Чего не хватает
## Восприятие + предсказание + планирование
### Поведенческое клонирование

### Обучение с подкреплением

### Почти сквозной подход для трамвая, опыт Яндекса

### Что дает подход
### Чего не хватает

## Модель мира
### Что это и как получается
### Какие плюсы
### Опыт Wave

## Материалы

---


[World Model vs VLM](https://chatgpt.com/share/67c04e9c-de0c-800b-904d-4d11bde0bfa5)

[Практика E2E](https://chatgpt.com/share/67d9776e-1388-800b-815e-f2dd41c793bc)

[Обзор и история E2E](https://chatgpt.com/share/67d97822-16bc-800b-9f9f-b5844a7b1bd7)

https://youtu.be/VKm4oI0VTdg?si=bRJFAlqL1WVLhhO6

https://youtu.be/CbSDKgTHvns?si=irCktnJ6gdXxmCQy

![[Learning a Driving Simulator]]

https://research.google/blog/introducing-dreamer-scalable-reinforcement-learning-using-world-models/

https://worldmodels.github.io/

[[Настоящее предназначение OpenAI SORA]]

https://arxiv.org/pdf/2306.16927

https://waabi.ai/detra/

https://waabi.ai/implicito/


